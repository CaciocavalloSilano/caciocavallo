<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Insert title here</title>
<script src="ResourceLoader?res=input.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHRShared.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHRBase64Transport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR2Shared.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR2PngTransport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR2RLETransport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=ImgTransport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=RLEImageDecoder.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR1RLETransport.js" type="text/javascript"></script>
<script type='text/javascript'>

var img;
var cmdStreamHeight;


var readCmdStreamFunc;
var startRequestFunc;

var subSessionID = SSID;

function init() {
	
	//alert(isXHR2Supported());
	
	/*if(false && isImageDataSupported()) {
		startRequestFunc = StartImageRequest;
		readCmdStreamFunc = readImageCommandStream;
	} else {
		startRequestFunc = StartXHRRequest;
		readCmdStreamFunc = readXHRCommandStream;
	}*/
	//initXHR1Rle();
	//initXHR2Png();
	//initImgTransport();
	
	initXHR2Rle();
    
    startRequestFunc(subSessionID);
	registerEventHandlers();
}

 
function interpretCommandBuffer() {		
	var canvas = document.getElementById('blackboard');
	var ctx = canvas.getContext('2d');
	
	var cmdPos = 0;
	var result = readCmdStreamFunc();
	var cmdBuffer = result.shortBuffer;
	cmdStreamHeight = result.cmdStreamHeight;
	
		  var cnt = 0;
		  
	while(cmdPos < cmdBuffer.length) {
	   var cmd = cmdBuffer[cmdPos++];
	  
	  switch(cmd) {		  
		case 0:  
		   {
			   if(cnt>0) {
				   var ab=0;}
			   var dstX1 = cmdBuffer[cmdPos++];
			   var dstY1 = cmdBuffer[cmdPos++];
			   var dstX2 = cmdBuffer[cmdPos++];
			   var dstY2 = cmdBuffer[cmdPos++];
			   var srcX1 = cmdBuffer[cmdPos++];
			   var srcY1 = cmdBuffer[cmdPos++] + cmdStreamHeight;
			   var width = dstX2 - dstX1;
			   var height = dstY2 - dstY1;
			   ctx.drawImage(img, srcX1, srcY1, width, height, dstX1, dstY1, width, height);
		   }
		   break;
		   
		case 1:
			{
			   if(cnt>0) {
				   var ab=0;}
			   var srcX1 = cmdBuffer[cmdPos++];
			   var srcY1 = cmdBuffer[cmdPos++];
			   var srcX2 = cmdBuffer[cmdPos++];
			   var srcY2 = cmdBuffer[cmdPos++];
			   var dstX1 = cmdBuffer[cmdPos++] + srcX1;
			   var dstY1 = cmdBuffer[cmdPos++] + srcY1;
			   var width = srcX2 - srcX1;
			   var height = srcY2 - srcY1;
			   var clipX = cmdBuffer[cmdPos++];
			   var clipY = cmdBuffer[cmdPos++];
			   var clipWidth = cmdBuffer[cmdPos++];
			   var clipHeight = cmdBuffer[cmdPos++];
			   
			   ctx.save();
			   ctx.beginPath();
			   ctx.rect(clipX, clipY, clipWidth, clipHeight);
			   ctx.clip(); 
			   
			   ctx.drawImage(canvas, srcX1, srcY1, width, height, dstX1, dstY1, width, height);
			   	  		  cnt++;
			   	  		  
			   ctx.restore();
		   }
		  break;
	  }
	  
	}
 
	startRequestFunc(subSessionID);
}




/*Event-Handling*/
var eventXmlHttpReq = new XMLHttpRequest();
var eventBuffer = '';

window.setInterval("sendEventsAtomic()", 10);

function __sendEvents() {
		if(eventBuffer.length > 0) {
		  var localEvents = 'subsessionid=SSID&events=' + eventBuffer;
		  eventBuffer = '';
		  eventXmlHttpReq.open('POST', 'EventReceiver', false);
		  eventXmlHttpReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		  eventXmlHttpReq.send(localEvents);
		}
}

function sendEventsAtomic() {
	if(eventBuffer.length > 0) {
		__sendEvents();
		//Mutex(eventBuffer, "__sendEvents()")
	}
}

function onMouseButton(e, down) {
    var evt, pos, bmask;

    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);
    bmask = 1 << evt.button;
    eventBuffer += 'M_'+pos.x+'_'+pos.y+'_'+down+'_'+bmask+'_';
    
   // sendEventsAtomic();
    //TODO: Immediatly flush
   
   // alert(eventBuffer);
    	
    pStopEvent(e);
    return false;
}

function onMouseDown(e) {
    onMouseButton(e, 1);
}

function onMouseUp(e) {
    onMouseButton(e, 0);
}

function onMouseWheel(e) {
    var evt, pos, bmask, wheelData;
    evt = (e ? e : window.event);
    pos = Util.getEventPosition(e, canvas, 1);
    wheelData = evt.detail ? evt.detail * -1 : evt.wheelDelta / 40;
    if (wheelData > 0) {
        bmask = 1 << 3;
    } else {
        bmask = 1 << 4;
    }

    /*if (c_mouseButton) {
        c_mouseButton(pos.x, pos.y, 1, bmask);
        c_mouseButton(pos.x, pos.y, 0, bmask);
    }*/
    
    pStopEvent(e);
    return false;
}

function onMouseMove(e) {
    var evt, pos;
    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);

    eventBuffer += 'MM_'+pos.x+'_'+pos.y+'_';
}

function onKeyDown(e) {
    /*if (c_keyPress) {
        c_keyPress(getKeysym(e), 1, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_1_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
   // sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyUp(e) {

/*    if (! conf.focused) {
        return true;
    }
    if (c_keyPress) {
        c_keyPress(getKeysym(e), 0, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_0_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
    //sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyPress(e) {
    /*if (! conf.focused) {
        return true;
    }*/
    pStopEvent(e);
    return false;
}


function registerEventHandlers() {
	  canvas = document.getElementById('blackboard');
    pAddEvent(document, 'keydown', onKeyDown);
    pAddEvent(document, 'keyup', onKeyUp);
    pAddEvent(document, 'keypress', onKeyPress);
    pAddEvent(canvas, 'mousedown', onMouseDown);
    pAddEvent(canvas, 'mouseup', onMouseUp);
    pAddEvent(canvas, 'mousemove', onMouseMove);
    /*Util.addEvent(c, (Util.Engine.gecko) ? 'DOMMouseScroll' : 'mousewheel',
            onMouseWheel);*/
    pRemoveEvent(document, 'click', onMouseDisable);
    pRemoveEvent(document.body, 'contextmenu', onMouseDisable);
}

</script>
</head>
<body onload='init();'>
<canvas id='blackboard' width='1024px' height='768px'></canvas>
</body>
</html>
