<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Insert title here</title>
<script src="ResourceLoader?res=novnc_input.js" type="text/javascript"></script>
<script type='text/javascript'>

var xmlhttpreq = new XMLHttpRequest();
  
function init() {
	registerEventHandlers();
	StartRequest();
}
 
function StartRequest() {
  // Persistente Verbindung Ã¶ffnen
  xmlhttpreq.open('GET', 'ImageStreamer?subsessionid=SSID', true);
  xmlhttpreq.onreadystatechange = handle_response;
  xmlhttpreq.send(null);
}
 
function handle_response() {
  if (xmlhttpreq.readyState==4 && xmlhttpreq.status==200) {
	    var canvas = document.getElementById('blackboard');
	    var ctx = canvas.getContext('2d');
	    
		var parNum = 0;
		var parts = xmlhttpreq.responseText.split(':');
	    
	    if(parts.length >= 4) {
				    
			while(parNum < parts.length) {
				var type = parts[parNum++];
									
				if(type == "i") {
					var x = parseInt(parts[parNum++]);
					var y = parseInt(parts[parNum++]);
					var imgData = parts[parNum++];
					console.log("drawImage x: "+x+" y:+"+y);
					
					//Response is URLEncoded, some browsers are disturbed by the slash used by base64
					imgData = 'data:image/png;base64,' + imgData; 
					
					var newImg = new Image();
					//TODO: Honor order
					newImg.onload = function() { ctx.drawImage(newImg, x, y);}
					newImg.src = imgData;	
				} else 
				if(type == "c") {
					var x = parseInt(parts[parNum++]);
					var y = parseInt(parts[parNum++]);
					var w = parseInt(parts[parNum++]);
					var h = parseInt(parts[parNum++]);
					var dx = parseInt(parts[parNum++]);
					var dy = parseInt(parts[parNum++]);
					
					//context.drawImage(img_elem, sx, sy, sw, sh, dx, dy, dw, dh);
					//alert("copyarea x: "+x+" y:"+y+" w:"+w+" h:"+h+" dx:"+dx+" dy:"+dy);
					ctx.drawImage(canvas, x - dx, y - dy, w, h, x, y, w, h);
				}
		  }
		}
  	}
  
  // Bei Verbindungsabbruch gleich neu initialisieren
  if (xmlhttpreq.readyState==4) {
    StartRequest();
  }
}

/*Event-Handling*/
var eventXmlHttpReq = new XMLHttpRequest();
var eventBuffer = '';

window.setInterval("sendEventsAtomic()", 10);

function __sendEvents() {
		if(eventBuffer.length > 0) {
		  var localEvents = 'subsessionid=SSID&events=' + eventBuffer;
		  eventBuffer = '';
		  eventXmlHttpReq.open('POST', 'EventReceiver', false);
		  eventXmlHttpReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		  eventXmlHttpReq.send(localEvents);
		}
}

function sendEventsAtomic() {
	if(eventBuffer.length > 0) {
		__sendEvents();
		//Mutex(eventBuffer, "__sendEvents()")
	}
}

function onMouseButton(e, down) {
    var evt, pos, bmask;

    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);
    bmask = 1 << evt.button;
    eventBuffer += 'M_'+pos.x+'_'+pos.y+'_'+down+'_'+bmask+'_';
    
   // sendEventsAtomic();
    //TODO: Immediatly flush
   
   // alert(eventBuffer);
    	
    pStopEvent(e);
    return false;
}

function onMouseDown(e) {
    onMouseButton(e, 1);
}

function onMouseUp(e) {
    onMouseButton(e, 0);
}

function onMouseWheel(e) {
    var evt, pos, bmask, wheelData;
    evt = (e ? e : window.event);
    pos = Util.getEventPosition(e, canvas, 1);
    wheelData = evt.detail ? evt.detail * -1 : evt.wheelDelta / 40;
    if (wheelData > 0) {
        bmask = 1 << 3;
    } else {
        bmask = 1 << 4;
    }

    /*if (c_mouseButton) {
        c_mouseButton(pos.x, pos.y, 1, bmask);
        c_mouseButton(pos.x, pos.y, 0, bmask);
    }*/
    
    pStopEvent(e);
    return false;
}

function onMouseMove(e) {
    var evt, pos;
    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);

    eventBuffer += 'MM_'+pos.x+'_'+pos.y+'_';
}

function onKeyDown(e) {
    /*if (c_keyPress) {
        c_keyPress(getKeysym(e), 1, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_1_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
   // sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyUp(e) {

/*    if (! conf.focused) {
        return true;
    }
    if (c_keyPress) {
        c_keyPress(getKeysym(e), 0, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_0_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
    //sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyPress(e) {
    /*if (! conf.focused) {
        return true;
    }*/
    pStopEvent(e);
    return false;
}


function registerEventHandlers() {
	  canvas = document.getElementById('blackboard');
    pAddEvent(document, 'keydown', onKeyDown);
    pAddEvent(document, 'keyup', onKeyUp);
    pAddEvent(document, 'keypress', onKeyPress);
    pAddEvent(canvas, 'mousedown', onMouseDown);
    pAddEvent(canvas, 'mouseup', onMouseUp);
    pAddEvent(canvas, 'mousemove', onMouseMove);
    /*Util.addEvent(c, (Util.Engine.gecko) ? 'DOMMouseScroll' : 'mousewheel',
            onMouseWheel);*/
    pRemoveEvent(document, 'click', onMouseDisable);
    pRemoveEvent(document.body, 'contextmenu', onMouseDisable);
}

</script>
</head>
<body onload='init();'>
<canvas id='blackboard' width='1024px' height='768px'></canvas>
</body>
</html>
