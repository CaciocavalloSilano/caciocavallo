<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Insert title here</title>
<script src="ResourceLoader?res=input.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHRShared.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHRBase64Transport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR2Shared.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR2PngTransport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR2RLETransport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=ImgTransport.js" type="text/javascript"></script>
<script src="ResourceLoader?res=RLEImageDecoder.js" type="text/javascript"></script>
<script src="ResourceLoader?res=XHR1RLETransport.js" type="text/javascript"></script>
<script type='text/javascript'>
var img;
var cmdStreamHeight;


var readCmdStreamFunc;
var startRequestFunc;

var subSessionID = SSID;

function init() {
	 fitCanvasToWindow();
	//alert(isXHR2Supported());
	//alert(isImageDataSupported());
	
	/*if(false && isImageDataSupported()) {
		startRequestFunc = StartImageRequest;
		readCmdStreamFunc = readImageCommandStream;
	} else {
		startRequestFunc = StartXHRRequest;
		readCmdStreamFunc = readXHRCommandStream;
	}*/
	initXHR1Rle();
	//initXHR2Png();
	//initImgTransport();
	//initXHR2Rle();
	//initXHRBase64();
    
    startRequestFunc(subSessionID);
	registerEventHandlers();
}

function fitCanvasToWindow() {
	var canvas = document.getElementById('blackboard');
	var tmpCanvas = document.createElement('canvas');
	tmpCanvas.setAttribute('width', canvas.width);
	tmpCanvas.setAttribute('height', canvas.height);
	var tmpCtx = tmpCanvas.getContext('2d');
	tmpCtx.drawImage(canvas, 0, 0);

	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	var ctx = canvas.getContext('2d');
	ctx.drawImage(tmpCanvas, 0, 0);

}

var lastWidth = -1;
var lastHeight = -1;
function resizeDelayed() {	
	 if(lastWidth != window.innerWidth || lastHeight != window.innerHeight) {
		 fitCanvasToWindow();
		 lastWidth = window.innerWidth;
		 lastHeight = window.innerHeight;
		 
		 eventBuffer += 'S_'+lastWidth+'_'+lastHeight+'_';
	 }
}

 
function interpretCommandBuffer() {		
	var canvas = document.getElementById('blackboard');
	var ctx = canvas.getContext('2d');
	
	var cmdPos = 0;
	var result = readCmdStreamFunc();
	var cmdBuffer = result.shortBuffer;
	cmdStreamHeight = result.cmdStreamHeight;
		  
	while(cmdPos < cmdBuffer.length) {
	   var cmd = cmdBuffer[cmdPos++];
	  
	  switch(cmd) {		  
		case 0:  
		   {
			   var dstX1 = cmdBuffer[cmdPos++];
			   var dstY1 = cmdBuffer[cmdPos++];
			   var dstX2 = cmdBuffer[cmdPos++];
			   var dstY2 = cmdBuffer[cmdPos++];
			   var srcX1 = cmdBuffer[cmdPos++];
			   var srcY1 = cmdBuffer[cmdPos++] + cmdStreamHeight;
			   var width = dstX2 - dstX1;
			   var height = dstY2 - dstY1;
			   ctx.drawImage(img, srcX1, srcY1, width, height, dstX1, dstY1, width, height);
		   }
		   break;
		   
		case 1:
			{
			   var srcX1 = cmdBuffer[cmdPos++];
			   var srcY1 = cmdBuffer[cmdPos++];
			   var srcX2 = cmdBuffer[cmdPos++];
			   var srcY2 = cmdBuffer[cmdPos++];
			   var dstX1 = cmdBuffer[cmdPos++] + srcX1;
			   var dstY1 = cmdBuffer[cmdPos++] + srcY1;
			   var width = srcX2 - srcX1;
			   var height = srcY2 - srcY1;
			   var clipX = cmdBuffer[cmdPos++];
			   var clipY = cmdBuffer[cmdPos++];
			   var clipWidth = cmdBuffer[cmdPos++];
			   var clipHeight = cmdBuffer[cmdPos++];
			   
			   ctx.save();
			   ctx.beginPath();
			   ctx.rect(clipX, clipY, clipWidth, clipHeight);
			   ctx.clip(); 
			   
			   ctx.drawImage(canvas, srcX1, srcY1, width, height, dstX1, dstY1, width, height);
			   	  		  
			   ctx.restore();
		   }
		  break;
	  }
	  
	}
 
	startRequestFunc(subSessionID);
}




/*Event-Handling*/
var eventXmlHttpReq = new XMLHttpRequest();
var eventBuffer = '';

window.setInterval("sendEventsAtomic()", 10);

function __sendEvents() {
		if(eventBuffer.length > 0) {
		  var localEvents = 'subsessionid=SSID&events=' + eventBuffer;
		  eventBuffer = '';
		  eventXmlHttpReq.open('POST', 'EventReceiver', false);
		  eventXmlHttpReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		  eventXmlHttpReq.send(localEvents);
		}
}

function sendEventsAtomic() {
	if(eventBuffer.length > 0) {
		__sendEvents();
		//Mutex(eventBuffer, "__sendEvents()")
	}
}

var isIE = navigator.userAgent.indexOf('MSIE') > -1;

function onMouseButton(e, down) {
    var evt, pos, button;

    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);
    
    button =  evt.button;
    if(isIE) {
	  switch(evt.button) {
		  case 1: 
		    button = 0;
		    break;
		  case 2:
			button = 2;
			break;
		  case 4:
			button = 1;
			break;
		  }
	}
    
    eventBuffer += 'M_'+pos.x+'_'+pos.y+'_'+down+'_'+button+'_';
    
    pStopEvent(e);
    return false;
}

function onMouseDown(e) {
    onMouseButton(e, 1);
}

function onMouseUp(e) {
    onMouseButton(e, 0);
}

function onMouseMove(e) {
    var evt, pos;
    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);

    eventBuffer += 'MM_'+pos.x+'_'+pos.y+'_';
}

function onKeyDown(e) {
    /*if (c_keyPress) {
        c_keyPress(getKeysym(e), 1, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_1_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
   // sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyUp(e) {

/*    if (! conf.focused) {
        return true;
    }
    if (c_keyPress) {
        c_keyPress(getKeysym(e), 0, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_0_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
    //sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyPress(e) {
    /*if (! conf.focused) {
        return true;
    }*/
    pStopEvent(e);
    return false;
}

function onMouseWheel(e) {
    var pos = pGetEventPosition(e, canvas, 1);
    var wheelDelta = (e.wheelDelta) ? e.wheelDelta : e.detail;
    
    eventBuffer += 'MW_'+wheelDelta+'_'+pos.x+'_'+pos.y+'_';
    
    pStopEvent(e);
	return false;
}

function onMouseDisable(e) {
	pStopEvent(e);
	return false;
}

function registerEventHandlers() {
    canvas = document.getElementById('blackboard');
    
    pAddEvent(window, "resize", function() { window.setTimeout("resizeDelayed()", 500)});

    pAddEvent(document, 'keydown', onKeyDown);
    pAddEvent(document, 'keyup', onKeyUp);
    pAddEvent(document, 'keypress', onKeyPress);
    pAddEvent(canvas, 'mousedown', onMouseDown);
    pAddEvent(canvas, 'mouseup', onMouseUp);
    pAddEvent(canvas, 'mousemove', onMouseMove);
            
    pAddEvent(window, "DOMMouseScroll", onMouseWheel);//Gecko
    pAddEvent(window, "mousewheel", onMouseWheel); //Safari, Opera
    pAddEvent(document, "mousewheel", onMouseWheel); //IE

    pAddEvent(document, 'click', onMouseDisable);
    pAddEvent(document.body, 'contextmenu', onMouseDisable);
    pAddEvent(canvas, 'click', onMouseDisable);
    pAddEvent(canvas, 'contextmenu', onMouseDisable);
}
</script>

<style>
	html, body { width: 100%; height: 100%; margin: 0px;}
    canvas {position:absolute; left:0px; top:0px; margin: 0px;}
</style>

</head>
<body onload="init();">
  <canvas id="blackboard"/>
</body>
</html>
