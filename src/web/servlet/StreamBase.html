<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Insert title here</title>
<script src="ResourceLoader?res=input.js" type="text/javascript"></script>
<script type='text/javascript'>

var img;
var cmdStreamHeight = 0;

function init() {
	if(isImageDataSupported()) {
		StartRequest();
		registerEventHandlers();
	} else {
		alert("Weird ImageData implementation, aborting");
	}
}

function readImgData(height) {
	var cmdCanvas = document.createElement('canvas');
	cmdCanvas.setAttribute('width', img.width);
	cmdCanvas.setAttribute('height', height);
	
	var cmdCtx = cmdCanvas.getContext('2d');
	cmdCtx.drawImage(img, 0, 0);
	 
	return cmdCtx.getImageData(0, 0, cmdCanvas.width, height);
}

function readCommandStream() {
	var imgData = readImgData(1); //Optimize to be higher by default for small images
    var imgDataArray = imgData.data;
    var cmdLength = (imgDataArray[0] << 16) + (imgDataArray[1] << 8) + (imgDataArray[2]);
    
    cmdStreamHeight = Math.ceil((cmdLength+3) / (img.width*3.0));
        
   // alert("length: "+cmdLength+" height: "+cmdStreamHeight);
    
    if(cmdStreamHeight > 1) {
	   //alert("re-reading image data: "+cmdAreaHeight);
	   imgData = readImgData(cmdStreamHeight);
	   imgDataArray = imgData.data;
	}
	
	var byteBuffer = new Array(cmdLength);
	var cmdPixelLength = Math.ceil(cmdLength / 3.0);
	for(var i=0; i < cmdPixelLength; i++) {
		var bytePos = i*3;
		if(bytePos < cmdLength) byteBuffer[bytePos++] = imgDataArray[(i+1)*4 + 0];
		if(bytePos < cmdLength) byteBuffer[bytePos++] = imgDataArray[(i+1)*4 + 1];
		if(bytePos < cmdLength) byteBuffer[bytePos++] = imgDataArray[(i+1)*4 + 2];
	}
	
	var shortBuffer = new Array(cmdLength / 2);
	for(var i=0; i < cmdLength / 2; i++) {
		var highByte = byteBuffer[i*2];
		var lowByte = byteBuffer[i*2 + 1];
		shortBuffer[i] = (highByte << 8) + lowByte;
	}
	
	//alert(shortBuffer);
	
	return shortBuffer;
}
 
function handleResponse() {		
	var canvas = document.getElementById('blackboard');
	var ctx = canvas.getContext('2d');
	
	var cmdPos = 0;
	var cmdBuffer = readCommandStream();
	while(cmdPos < cmdBuffer.length) {
	   var cmd = cmdBuffer[cmdPos++];
	  
	   //Blit command
	   if(cmd == 0) {
		   var dstX1 = cmdBuffer[cmdPos++];
		   var dstY1 = cmdBuffer[cmdPos++];
		   var dstX2 = cmdBuffer[cmdPos++];
		   var dstY2 = cmdBuffer[cmdPos++];
		   var srcX1 = cmdBuffer[cmdPos++];
		   var srcY1 = cmdBuffer[cmdPos++] + cmdStreamHeight;
		   var width = dstX2 - dstX1;
		   var height = dstY2 - dstY1;

//		   alert(Object.prototype.toString.call(dstX1));
		   if(cmdStreamHeight > 1) {
			//alert("Issuing drawImage: srcX:"+ srcX1 +" srcy:" + srcY1 + " width:" + width+ " height:" + height + " dstx1:" + dstX1+ " dsty2:" + dstY2+ " imgW:" + img.width+ " imgH:" + img.height);
		   }
		   ctx.drawImage(img, srcX1, srcY1, width, height, dstX1, dstY1, width, height)
	   }	
	}
 
	StartRequest();
}

function StartRequest() {
  var randParam = parseInt(Math.random() * 99999999);
  
  img = new Image();  
  img.src = 'ImageStreamer?subsessionid=SSID&rand='+randParam;
  img.onload = handleResponse;
}


function isImageDataSupported() {
	var canvas = document.createElement('canvas');
	canvas.setAttribute('width', 256);
	canvas.setAttribute('height', 1);
	var ctx = canvas.getContext('2d');
	
	var writeImgData = ctx.createImageData(256, 1);
	var writePixelArray = writeImgData.data; //RGBA
	for(x=0; x < 256; x++) {
		writePixelArray[x*4 + 0] = x;
		writePixelArray[x*4 + 1] = x;
		writePixelArray[x*4 + 2] = x;
		writePixelArray[x*4 + 3] = 255;
	}
	
	ctx.putImageData(writeImgData, 0, 0);
	
	var readImgData = ctx.getImageData(0, 0, 256, 1);
	var readPixelArray = readImgData.data; //RGBA
	
	for(x=0; x < 256; x++) {
		if( (readPixelArray[x*4 + 0] != x) || (readPixelArray[x*4 + 1] != x) || 
		    (readPixelArray[x*4 + 2] != x) || (readPixelArray[x*4 + 3] != 255)) {
		  return false;
		}
	}
	
	return true;
}

/*Event-Handling*/
var eventXmlHttpReq = new XMLHttpRequest();
var eventBuffer = '';

window.setInterval("sendEventsAtomic()", 10);

function __sendEvents() {
		if(eventBuffer.length > 0) {
		  var localEvents = 'subsessionid=SSID&events=' + eventBuffer;
		  eventBuffer = '';
		  eventXmlHttpReq.open('POST', 'EventReceiver', false);
		  eventXmlHttpReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		  eventXmlHttpReq.send(localEvents);
		}
}

function sendEventsAtomic() {
	if(eventBuffer.length > 0) {
		__sendEvents();
		//Mutex(eventBuffer, "__sendEvents()")
	}
}

function onMouseButton(e, down) {
    var evt, pos, bmask;

    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);
    bmask = 1 << evt.button;
    eventBuffer += 'M_'+pos.x+'_'+pos.y+'_'+down+'_'+bmask+'_';
    
   // sendEventsAtomic();
    //TODO: Immediatly flush
   
   // alert(eventBuffer);
    	
    pStopEvent(e);
    return false;
}

function onMouseDown(e) {
    onMouseButton(e, 1);
}

function onMouseUp(e) {
    onMouseButton(e, 0);
}

function onMouseWheel(e) {
    var evt, pos, bmask, wheelData;
    evt = (e ? e : window.event);
    pos = Util.getEventPosition(e, canvas, 1);
    wheelData = evt.detail ? evt.detail * -1 : evt.wheelDelta / 40;
    if (wheelData > 0) {
        bmask = 1 << 3;
    } else {
        bmask = 1 << 4;
    }

    /*if (c_mouseButton) {
        c_mouseButton(pos.x, pos.y, 1, bmask);
        c_mouseButton(pos.x, pos.y, 0, bmask);
    }*/
    
    pStopEvent(e);
    return false;
}

function onMouseMove(e) {
    var evt, pos;
    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);

    eventBuffer += 'MM_'+pos.x+'_'+pos.y+'_';
}

function onKeyDown(e) {
    /*if (c_keyPress) {
        c_keyPress(getKeysym(e), 1, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_1_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
   // sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyUp(e) {

/*    if (! conf.focused) {
        return true;
    }
    if (c_keyPress) {
        c_keyPress(getKeysym(e), 0, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_0_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
    //sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyPress(e) {
    /*if (! conf.focused) {
        return true;
    }*/
    pStopEvent(e);
    return false;
}


function registerEventHandlers() {
	  canvas = document.getElementById('blackboard');
    pAddEvent(document, 'keydown', onKeyDown);
    pAddEvent(document, 'keyup', onKeyUp);
    pAddEvent(document, 'keypress', onKeyPress);
    pAddEvent(canvas, 'mousedown', onMouseDown);
    pAddEvent(canvas, 'mouseup', onMouseUp);
    pAddEvent(canvas, 'mousemove', onMouseMove);
    /*Util.addEvent(c, (Util.Engine.gecko) ? 'DOMMouseScroll' : 'mousewheel',
            onMouseWheel);*/
    pRemoveEvent(document, 'click', onMouseDisable);
    pRemoveEvent(document.body, 'contextmenu', onMouseDisable);
}

</script>
</head>
<body onload='init();'>
<canvas id='blackboard' width='1024px' height='768px'></canvas>
</body>
</html>
