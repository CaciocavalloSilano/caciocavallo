<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Insert title here</title>
<!--<script type="text/javascript" src="Input.js"></script>
<script type="text/javascript" src="JSMutex.js"></script> -->
<script type='text/javascript'>

//Event registration. Based on: http://www.scottandrew.com/weblog/articles/cbs-events
pAddEvent = function (obj, evType, fn){
    if (obj.attachEvent){
        var r = obj.attachEvent("on"+evType, fn);
        return r;
    } else if (obj.addEventListener){
        obj.addEventListener(evType, fn, false); 
        return true;
    } else {
        throw("Handler could not be attached");
    }
};

pRemoveEvent = function(obj, evType, fn){
    if (obj.detachEvent){
        var r = obj.detachEvent("on"+evType, fn);
        return r;
    } else if (obj.removeEventListener){
        obj.removeEventListener(evType, fn, false);
        return true;
    } else {
        throw("Handler could not be removed");
    }
};

pStopEvent = function(e) {
    if (e.stopPropagation) { e.stopPropagation(); }
    else                   { e.cancelBubble = true; }

    if (e.preventDefault)  { e.preventDefault(); }
    else                   { e.returnValue = false; }
};

pGetPosition = function (obj) {
    var x = 0, y = 0;
    if (obj.offsetParent) {
        do {
            x += obj.offsetLeft;
            y += obj.offsetTop;
            obj = obj.offsetParent;
        } while (obj);
    }
    return {'x': x, 'y': y};
};


pGetEventPosition = function (e, obj, scale) {
    var evt, docX, docY, pos;
    //if (!e) evt = window.event;
    evt = (e ? e : window.event);
    if (evt.pageX || evt.pageY) {
        docX = evt.pageX;
        docY = evt.pageY;
    } else if (evt.clientX || evt.clientY) {
        docX = evt.clientX + document.body.scrollLeft +
            document.documentElement.scrollLeft;
        docY = evt.clientY + document.body.scrollTop +
            document.documentElement.scrollTop;
    }
    pos = pGetPosition(obj);
    if (typeof scale === "undefined") {
        scale = 1;
    }
    return {'x': (docX - pos.x) / scale, 'y': (docY - pos.y) / scale};
};

function onMouseDisable(e) {
    var evt, pos;
    if (! conf.focused) {
        return true;
    }
    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);
    /* Stop propagation if inside canvas area */
    if ((pos.x >= 0) && (pos.y >= 0) &&
        (pos.x < c_width) && (pos.y < c_height)) {
        //Util.Debug("mouse event disabled");
        pStopEvent(e);
        return false;
    }
    //Util.Debug("mouse event not disabled");
    return true;
}


/* Translate DOM key down/up event to keysym value */
function getKeysym(e) {
    var evt, keysym;
    evt = (e ? e : window.event);

    /* Remap modifier and special keys */
    switch ( evt.keyCode ) {
        case 8         : keysym = 0xFF08; break; // BACKSPACE
        case 9         : keysym = 0xFF09; break; // TAB
        case 13        : keysym = 0xFF0D; break; // ENTER
        case 27        : keysym = 0xFF1B; break; // ESCAPE
        case 45        : keysym = 0xFF63; break; // INSERT
        case 46        : keysym = 0xFFFF; break; // DELETE
        case 36        : keysym = 0xFF50; break; // HOME
        case 35        : keysym = 0xFF57; break; // END
        case 33        : keysym = 0xFF55; break; // PAGE_UP
        case 34        : keysym = 0xFF56; break; // PAGE_DOWN
        case 37        : keysym = 0xFF51; break; // LEFT
        case 38        : keysym = 0xFF52; break; // UP
        case 39        : keysym = 0xFF53; break; // RIGHT
        case 40        : keysym = 0xFF54; break; // DOWN
        case 112       : keysym = 0xFFBE; break; // F1
        case 113       : keysym = 0xFFBF; break; // F2
        case 114       : keysym = 0xFFC0; break; // F3
        case 115       : keysym = 0xFFC1; break; // F4
        case 116       : keysym = 0xFFC2; break; // F5
        case 117       : keysym = 0xFFC3; break; // F6
        case 118       : keysym = 0xFFC4; break; // F7
        case 119       : keysym = 0xFFC5; break; // F8
        case 120       : keysym = 0xFFC6; break; // F9
        case 121       : keysym = 0xFFC7; break; // F10
        case 122       : keysym = 0xFFC8; break; // F11
        case 123       : keysym = 0xFFC9; break; // F12
        case 16        : keysym = 0xFFE1; break; // SHIFT
        case 17        : keysym = 0xFFE3; break; // CONTROL
        //case 18        : keysym = 0xFFE7; break; // Left Meta (Mac Option)
        case 18        : keysym = 0xFFE9; break; // Left ALT (Mac Command)
        default        : keysym = evt.keyCode; break;
    }

    /* Remap symbols */
    switch (keysym) {
        case 186       : keysym = 59; break; // ;  (IE)
        case 187       : keysym = 61; break; // =  (IE)
        case 188       : keysym = 44; break; // ,  (Mozilla, IE)
        case 109       :                     // -  (Mozilla, Opera)
            if (Util.Engine.gecko || Util.Engine.presto) {
                         keysym = 45; }
                                      break;
        case 189       : keysym = 45; break; // -  (IE)
        case 190       : keysym = 46; break; // .  (Mozilla, IE)
        case 191       : keysym = 47; break; // /  (Mozilla, IE)
        case 192       : keysym = 96; break; // `  (Mozilla, IE)
        case 219       : keysym = 91; break; // [  (Mozilla, IE)
        case 220       : keysym = 92; break; // \  (Mozilla, IE)
        case 221       : keysym = 93; break; // ]  (Mozilla, IE)
        case 222       : keysym = 39; break; // '  (Mozilla, IE)
    }
    
    /* Remap shifted and unshifted keys */
    if (!!evt.shiftKey) {
        switch (keysym) {
            case 48        : keysym = 41 ; break; // )  (shifted 0)
            case 49        : keysym = 33 ; break; // !  (shifted 1)
            case 50        : keysym = 64 ; break; // @  (shifted 2)
            case 51        : keysym = 35 ; break; // #  (shifted 3)
            case 52        : keysym = 36 ; break; // $  (shifted 4)
            case 53        : keysym = 37 ; break; // %  (shifted 5)
            case 54        : keysym = 94 ; break; // ^  (shifted 6)
            case 55        : keysym = 38 ; break; // &  (shifted 7)
            case 56        : keysym = 42 ; break; // *  (shifted 8)
            case 57        : keysym = 40 ; break; // (  (shifted 9)

            case 59        : keysym = 58 ; break; // :  (shifted `)
            case 61        : keysym = 43 ; break; // +  (shifted ;)
            case 44        : keysym = 60 ; break; // <  (shifted ,)
            case 45        : keysym = 95 ; break; // _  (shifted -)
            case 46        : keysym = 62 ; break; // >  (shifted .)
            case 47        : keysym = 63 ; break; // ?  (shifted /)
            case 96        : keysym = 126; break; // ~  (shifted `)
            case 91        : keysym = 123; break; // {  (shifted [)
            case 92        : keysym = 124; break; // |  (shifted \)
            case 93        : keysym = 125; break; // }  (shifted ])
            case 39        : keysym = 34 ; break; // "  (shifted ')
        }
    } else if ((keysym >= 65) && (keysym <=90)) {
        /* Remap unshifted A-Z */
        keysym += 32;
    } else if (evt.keyLocation === 3) {
        // numpad keys
        switch (keysym) {
            case 96 : keysym = 48; break; // 0
            case 97 : keysym = 49; break; // 1
            case 98 : keysym = 50; break; // 2
            case 99 : keysym = 51; break; // 3
            case 100: keysym = 52; break; // 4
            case 101: keysym = 53; break; // 5
            case 102: keysym = 54; break; // 6
            case 103: keysym = 55; break; // 7
            case 104: keysym = 56; break; // 8
            case 105: keysym = 57; break; // 9
            case 109: keysym = 45; break; // -
            case 110: keysym = 46; break; // .
            case 111: keysym = 47; break; // /
        }
    }

    return keysym;
}


var xmlhttpreq = new XMLHttpRequest();
  
function init() {
	registerEventHandlers();
	StartRequest();
}
 
function StartRequest() {
  // Persistente Verbindung Ã¶ffnen
  xmlhttpreq.open('GET', 'ImageStreamer?subsessionid=SSID', true);
  xmlhttpreq.onreadystatechange = handle_response;
  xmlhttpreq.send(null);
}
 
function handle_response() {
  if (xmlhttpreq.readyState==4 && xmlhttpreq.status==200) {
	    var ctx = document.getElementById('blackboard').getContext('2d');
	    
	    /* TODO: Implement multipart-messages - only go on in the onload-handler
	     */
	    var parts = xmlhttpreq.responseText.split(':');
	    if(parts.length >= 3) {
		    var x = parseInt(parts[0]);
		    var y = parseInt(parts[1]);
		    var imgData = parts[2];
		    
		    //Response is URLEncoded, some browsers are disturbed by the slash used by base64
		    imgData = 'data:image/png;base64,' + imgData; 
		    
		    var newImg = new Image();
				newImg.onload = function() { ctx.drawImage(newImg, x, y);}
				newImg.src = imgData;	 	 
	    }
  	}
  
  // Bei Verbindungsabbruch gleich neu initialisieren
  if (xmlhttpreq.readyState==4) {
    StartRequest();
  }
}

/*Event-Handling*/
var eventXmlHttpReq = new XMLHttpRequest();
var eventBuffer = '';

window.setInterval("sendEventsAtomic()", 10);

function __sendEvents() {
		if(eventBuffer.length > 0) {
		  var localEvents = 'subsessionid=SSID&events=' + eventBuffer;
		  eventBuffer = '';
		  eventXmlHttpReq.open('POST', 'EventReceiver', false);
		  eventXmlHttpReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		  eventXmlHttpReq.send(localEvents);
		}
}

function sendEventsAtomic() {
	if(eventBuffer.length > 0) {
		__sendEvents();
		//Mutex(eventBuffer, "__sendEvents()")
	}
}

function onMouseButton(e, down) {
    var evt, pos, bmask;

    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);
    bmask = 1 << evt.button;
    eventBuffer += 'M_'+pos.x+'_'+pos.y+'_'+down+'_'+bmask+'_';
    
   // sendEventsAtomic();
    //TODO: Immediatly flush
   
   // alert(eventBuffer);
    	
    pStopEvent(e);
    return false;
}

function onMouseDown(e) {
    onMouseButton(e, 1);
}

function onMouseUp(e) {
    onMouseButton(e, 0);
}

function onMouseWheel(e) {
    var evt, pos, bmask, wheelData;
    evt = (e ? e : window.event);
    pos = Util.getEventPosition(e, canvas, 1);
    wheelData = evt.detail ? evt.detail * -1 : evt.wheelDelta / 40;
    if (wheelData > 0) {
        bmask = 1 << 3;
    } else {
        bmask = 1 << 4;
    }

    /*if (c_mouseButton) {
        c_mouseButton(pos.x, pos.y, 1, bmask);
        c_mouseButton(pos.x, pos.y, 0, bmask);
    }*/
    
    pStopEvent(e);
    return false;
}

function onMouseMove(e) {
    var evt, pos;
    evt = (e ? e : window.event);
    pos = pGetEventPosition(e, canvas, 1);

    eventBuffer += 'MM_'+pos.x+'_'+pos.y+'_';
}

function onKeyDown(e) {
    /*if (c_keyPress) {
        c_keyPress(getKeysym(e), 1, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_1_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
   // sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyUp(e) {

/*    if (! conf.focused) {
        return true;
    }
    if (c_keyPress) {
        c_keyPress(getKeysym(e), 0, e.ctrlKey, e.shiftKey, e.altKey);
    }*/
    
    eventBuffer += 'K_0_'+getKeysym(e)+"_"+e.ctrlKey+"_"+e.shiftKey+"_"+e.altKey+'_';
    //sendEventsAtomic();
    
    pStopEvent(e);
    return false;
}

function onKeyPress(e) {
    /*if (! conf.focused) {
        return true;
    }*/
    pStopEvent(e);
    return false;
}


function registerEventHandlers() {
	  canvas = document.getElementById('blackboard');
    pAddEvent(document, 'keydown', onKeyDown);
    pAddEvent(document, 'keyup', onKeyUp);
    pAddEvent(document, 'keypress', onKeyPress);
    pAddEvent(canvas, 'mousedown', onMouseDown);
    pAddEvent(canvas, 'mouseup', onMouseUp);
    pAddEvent(canvas, 'mousemove', onMouseMove);
    /*Util.addEvent(c, (Util.Engine.gecko) ? 'DOMMouseScroll' : 'mousewheel',
            onMouseWheel);*/
    pRemoveEvent(document, 'click', onMouseDisable);
    pRemoveEvent(document.body, 'contextmenu', onMouseDisable);
}

</script>
</head>
<body onload='init();'>
<canvas id='blackboard' width='1024px' height='768px'></canvas>
</body>
</html>
